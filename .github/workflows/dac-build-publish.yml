name: DAC Build & Milestone Publisher

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout DAC
        uses: actions/checkout@v4

      - name: Get Author Email
        run: |
          DEV_EMAIL=$(git log -1 --pretty=format:'%ae')
          echo "DEV_EMAIL=$DEV_EMAIL" >> $GITHUB_ENV

      - name: Get Build Time IST
        run: |
          BUILD_TIME_IST=$(date -d '+5 hour +30 minutes' '+%Y-%m-%d %H:%M:%S IST')
          echo "RUN_TIME_IST=$BUILD_TIME_IST" >> $GITHUB_ENV

      - name: Create DAC Zip
        run: |
          zip -r dac_server.zip . -x ".git/*" ".github/*" "README.md" "milestone/*"

      - name: Get Zip Size
        run: |
          ZIP_SIZE=$(du -h dac_server.zip | cut -f1)
          echo "ZIP_SIZE=$ZIP_SIZE" >> $GITHUB_ENV

      - name: Clone DAC_Milestone Repo
        run: |
          git clone https://x-access-token:${{ secrets.PUSH_TOKEN }}@github.com/Braghadeesh005/DAC_Milestone.git milestone

      - name: Setup Versioning
        run: |
          cd milestone
          if [ -d default ] && [ -f default/blog.txt ]; then
            LAST_VERSION=$(grep "VERSION:" default/blog.txt | tail -1 | awk '{print $2}')
            NEW_VERSION=$(awk "BEGIN {printf \"%.1f\", $LAST_VERSION + 0.1}")
          else
            NEW_VERSION="1.0"
          fi
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Archive Old Default
        run: |
          cd milestone
          if [ -d default ]; then
            BUILD_TIME=$(date "+%Y-%m-%d_%H-%M-%S")
            mv default dac_$BUILD_TIME
          fi
          mkdir default

      - name: Move Zip into milestone
        run: |
          cp ../dac_server.zip milestone/default/

      - name: Create blog.txt Metadata
        run: |
          cd milestone/default
          echo "VERSION: $NEW_VERSION" >> blog.txt
          echo "BUILD_TIME: $RUN_TIME_IST" >> blog.txt
          echo "COMMIT_ID: $GITHUB_SHA" >> blog.txt
          echo "COMMITTER: $GITHUB_ACTOR" >> blog.txt
          echo "COMMIT_EMAIL: $DEV_EMAIL" >> blog.txt
          echo "BRANCH: $GITHUB_REF_NAME" >> blog.txt
          echo "ZIP_NAME: dac_server.zip" >> blog.txt
          echo "ZIP_SIZE: $ZIP_SIZE" >> blog.txt

      - name: Commit & Push to DAC_Milestone
        run: |
          cd milestone
          git config user.name "dac-actions"
          git config user.email "dac@github.com"
          git add .
          git commit -m "DAC Build v$NEW_VERSION"
          git push

      - name: Prepare HTML Email (Success)
        if: success()
        run: |
          sed -e "s/{{VERSION}}/${{ env.NEW_VERSION }}/g" \
              -e "s/{{COMMIT_ID}}/${GITHUB_SHA}/g" \
              -e "s/{{COMMITTER}}/${GITHUB_ACTOR}/g" \
              -e "s/{{COMMIT_EMAIL}}/${{ env.DEV_EMAIL }}/g" \
              -e "s/{{BRANCH}}/main/g" \
              -e "s/{{ZIP_NAME}}/dac_server.zip/g" \
              -e "s/{{ZIP_SIZE}}/${{ env.ZIP_SIZE }}/g" \
              -e "s/{{BUILD_TIME}}/${{ env.RUN_TIME_IST }}/g" \
              -e "s/{{TARGET_REPO}}/DAC_Milestone/g" \
              -e "s|{{ACTIONS_URL}}|https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|g" \
              .github/email_templates/success.html > success_email.html

      - name: Send Success Email
        if: success()
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "DAC Build SUCCESS - v${{ env.NEW_VERSION }}"
          to: ${{ secrets.MAIL_TO_STATIC }},${{ env.DEV_EMAIL }}
          from: "DAC CI <${{ secrets.MAIL_USERNAME }}>"
          html_body: file://success_email.html

      - name: Prepare HTML Email (Failure)
        if: failure()
        run: |
          sed -e "s/{{VERSION}}/${{ env.NEW_VERSION }}/g" \
              -e "s/{{COMMIT_ID}}/${GITHUB_SHA}/g" \
              -e "s/{{COMMITTER}}/${GITHUB_ACTOR}/g" \
              -e "s/{{COMMIT_EMAIL}}/${{ env.DEV_EMAIL }}/g" \
              -e "s/{{BRANCH}}/main/g" \
              -e "s/{{ZIP_NAME}}/dac_server.zip/g" \
              -e "s/{{ZIP_SIZE}}/${{ env.ZIP_SIZE }}/g" \
              -e "s/{{BUILD_TIME}}/${{ env.RUN_TIME_IST }}/g" \
              -e "s/{{TARGET_REPO}}/DAC_Milestone/g" \
              -e "s|{{ACTIONS_URL}}|https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|g" \
              .github/email_templates/failure.html > failure_email.html

      - name: Send Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "DAC Build FAILED"
          to: ${{ secrets.MAIL_TO_STATIC }},${{ env.DEV_EMAIL }}
          from: "DAC CI <${{ secrets.MAIL_USERNAME }}>"
          html_body: file://failure_email.html
